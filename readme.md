# Сервер регистрации IoT устройств

Этот сервер обеспечивает регистрацию и управление IoT устройствами через REST API, построенный на FastAPI. Он позволяет устройствам регистрироваться в системе, получать темы MQTT на основе их уникальных идентификаторов и получать/устанавливать параметры конфигурации.

## Функциональность

- **Регистрация устройств**: Позволяет IoT устройствам регистрироваться в системе
- **Управление темами MQTT**: Автоматически создает темы по шаблону `владелец/местоположение/тип_измерений/идентификатор_устройства`
- **Управление конфигурацией**: Позволяет получать и обновлять конфигурации устройств
- **Уведомления через Telegram**: Отправляет уведомления администраторам и владельцам устройств при регистрации новых устройств

## Конечные точки API

### Регистрация устройства

```
POST /register/
```

Пример тела запроса:
```json
{
  "longitude": 101.7121,
  "latitude": 56.2928,
  "height": 428,
  "city": "Bratsk",
  "owner": "Lyceum",
  "measurement_type": "temperature",
  "sensor_model": "string",
  "mac_address": "00:00:00:00:00:00"
}
```

Ответ:
```json
{
  "device_id": "generated_device_id",
  "topic": "owner/location/measurement_type/device_id"
}
```

При регистрации устройства:
1. Генерируется уникальный ID устройства на основе MAC-адреса
2. Отправляется уведомление системному администратору
3. Если владелец зарегистрирован в Telegram боте, он также получает уведомление

### Получение тем устройства

```
GET /topics/{device_id}
```

Возвращает темы MQTT, связанные с конкретным устройством.

### Получение конфигурации устройства

```
GET /config/{device_id}
```

Возвращает текущую конфигурацию устройства.

### Обновление конфигурации устройства

```
PUT /config/{device_id}
```

Обновляет конфигурацию для конкретного устройства.

### Удаление устройства

```
DELETE /device/{device_id}
```

Удаляет устройство из системы.

### Обновление информации об устройстве

```
PUT /device/{device_id}
```

Обновляет информацию об устройстве.

## Интеграция с Telegram ботом

Система включает Telegram бота, который отправляет уведомления при регистрации новых устройств. Бот:

- Уведомляет системных администраторов обо всех регистрациях
- Уведомляет владельцев устройств при регистрации их устройств (если они зарегистрированы в боте)
- Поддерживает команды `/start` и `/chatid` для взаимодействия с пользователем

## Конфигурация

Сервер требует следующие переменные окружения:

```
TELEGRAM_BOT_TOKEN=ваш_токен_телеграм_бота
TELEGRAM_CHAT_ID=ваш_идентификатор_чата  # ID чата администратора
```

## Запуск сервера

```bash
uvicorn main:app --host 0.0.0.0 --port 8008
```

Сервер автоматически запустит Telegram бота в фоновом потоке.

## Архитектура

Сервер использует FastAPI для REST API и применяет фоновые задачи для асинхронной отправки уведомлений через Telegram, не блокируя ответы API.
